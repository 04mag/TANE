@using System.Collections.ObjectModel
@using TANE.Application.Groups.DagSkabeloner.Queries.Interfaces
@using TANE.Application.Groups.TurSkabeloner.Commands
@using TANE.Application.Groups.TurSkabeloner.Commands.Interfaces
@using TANE.Application.Groups.TurSkabeloner.Queries.Interfaces
@using TANE.Domain.Entities
@using TANE.Presentation.BlazorWebAssemply.Configuration
@using TANE.Presentation.BlazorWebAssemply.Pages.Skabeloner.DagSkabeloner.Components

@inject CustomStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IReadTurSkabelon ReadTurSkabelon
@inject IReadDagSkabelon ReadDagSkabelon
@inject ICreateTurSkabelon CreateTurSkabelon
@inject IUpdateTurSkabelon UpdateTurSkabelon

@if (TurSkabelon != null)
{
    <div class="rz-p-0 rz-p-md-12">
        <!-- Flex-container med 100% bredde -->
        <RadzenTemplateForm TItem="TurSkabelon" Data=@TurSkabelon Submit=@OnSubmit InvalidSubmit=@OnInvalidSubmit>
            <RadzenStack Gap="1rem" class="rz-p-sm-12">


                <div style="display:flex; justify-content:flex-end; margin-bottom:1rem;">
                    <RadzenButton ButtonType="ButtonType.Submit"
                                  Size="ButtonSize.Large"
                                  Text="@SaveButtonText" />
                </div>

                <!-- Id -->
                <RadzenFormField Text="ID" Variant="@ThemeConfig.FormVariant">
                    <ChildContent>
                        <RadzenNumeric Name="Id" @bind-Value=@TurSkabelon.Id Style="width: 100%" Disabled="true" />
                    </ChildContent>
                </RadzenFormField>

                <!-- Titel -->
                <RadzenFormField Text="Titel" Variant="@ThemeConfig.FormVariant">
                    <ChildContent>
                        <RadzenTextBox Name="Titel" @bind-Value=@TurSkabelon.Titel Style="width: 100%" />
                    </ChildContent>
                    <Helper>
                        <RadzenRequiredValidator Component="Titel" Text="Titel skal udfyldes." />
                    </Helper>
                </RadzenFormField>

                <!-- Beskrivelse -->
                <RadzenFormField Text="Beskrivelse" Variant="@ThemeConfig.FormVariant">
                    <ChildContent>
                        <RadzenTextArea Name="Beskrivelse" @bind-Value=@TurSkabelon.Beskrivelse Rows="4" Style="width: 100%" />
                    </ChildContent>
                    <Helper>
                        <RadzenRequiredValidator Component="Beskrivelse" Text="Beskrivelse skal udfyldes." />
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Pris" Variant="@ThemeConfig.FormVariant">
                    <ChildContent>
                        <RadzenNumeric Name="Pris" @bind-Value=@TurSkabelon.Pris Style="width: 100%" />
                    </ChildContent>
                </RadzenFormField>



                <h3>Dage:</h3>
                <DagSkabelonReorderListComponent InjectedDagSkabeloner="ObservableDage" OnDelete="OnDagSkabelonDelete" />
                <div style="text-align: right; width: 100%;">
                    <RadzenButton ButtonType="ButtonType.Button" Size="ButtonSize.Medium" Style="width: 150px" Text="Tilføj Dag" Click="OpenCreateDagSkabelonDialog"></RadzenButton>
                </div>

            </RadzenStack>
        </RadzenTemplateForm>
    </div>
}
else
{
    <h4>Tur skabelon kunne ikke indlæses</h4>
}

@code {
    bool showAddDagSkabelon = false;

    public TurSkabelon? TurSkabelon { get; set; } = new TurSkabelon();

    public List<DagSkabelon> DagSkabeloner { get; set; } = new List<DagSkabelon>();

    public ObservableCollection<DagSkabelon> ObservableDage { get; set; } = new();

    [Parameter]
    public int Id { get; set; } = 0;

    private string saveButtonTextVar = "Gem skabelon";

    public string SaveButtonText
    {
        get { return saveButtonTextVar; }
        set { saveButtonTextVar = value; }
    }

    protected override async Task OnInitializedAsync()
    {
        await AuthStateProvider.RefreshTokenAsync(NavigationManager, NotificationService);

        try
        {
            DagSkabeloner = await ReadDagSkabelon.ReadAllDagSkabelonerAsync(AuthStateProvider.CurrentUser.Token);
        }
        catch
        {
            
        }

        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Id == 0)
        {
            TurSkabelon = new TurSkabelon();

            SaveButtonText = "Opret skabelon";
        }
        else
        {
            await AuthStateProvider.RefreshTokenAsync(NavigationManager, NotificationService);

            try
            {
                TurSkabelon = await ReadTurSkabelon.ReadTurSkabelonByIdAsync(Id, AuthStateProvider.CurrentUser.Token);

                ObservableDage = new ObservableCollection<DagSkabelon>(TurSkabelon.Dage);

                if (TurSkabelon.Id == 0)
                {
                    throw new Exception("Tur skabelon ikke fundet");
                }
            }
            catch
            {
                NotificationService.Notify(new NotificationMessage()
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Fejl",
                        Detail = "Der opstod en fejl under hentning af tur skabelon.",
                        Duration = 5000
                    });

                TurSkabelon = null;
            }
        }

        await base.OnParametersSetAsync();
    }

    async Task OnSubmit()
    {
        TurSkabelon!.Dage = ObservableDage.ToList();

        if (TurSkabelon.Id == 0)
        {
            try
            {
                await CreateTurSkabelon.CreateTurSkabelonAsync(TurSkabelon, AuthStateProvider.CurrentUser.Token);
                NotificationService.Notify(new NotificationMessage()
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "Oprettet",
                        Detail = "Tur skabelon oprettet",
                        Duration = 5000
                    });
                NavigationManager.NavigateTo("/skabeloner/tur");
            }
            catch (Exception ex)
            {
                NotificationService.Notify(new NotificationMessage()
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Fejl",
                        Detail = ex.Message,
                        Duration = 5000
                    });
            }
        }
        else
        {
            try
            {
                await UpdateTurSkabelon.UpdateTurSkabelonAsync(TurSkabelon, AuthStateProvider.CurrentUser.Token);
                NotificationService.Notify(new NotificationMessage()
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "Opdateret",
                        Detail = "Tur skabelon opdateret",
                        Duration = 5000
                    });
                NavigationManager.NavigateTo("/skabeloner/tur");
            }
            catch (Exception ex)
            {
                NotificationService.Notify(new NotificationMessage()
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Fejl",
                        Detail = ex.Message,
                        Duration = 5000
                    });
            }
        }

    }

    void OnInvalidSubmit(FormInvalidSubmitEventArgs args)
    {

    }

    void OnDagSkabelonDelete(DagSkabelon dagSkabelon)
    {
        ObservableDage.Remove(dagSkabelon);
    }

    private void OnDagSkabelonAdd(DagSkabelon dagSkabelon)
    {
        ObservableDage.Add(dagSkabelon);

        showAddDagSkabelon = !showAddDagSkabelon;

        DialogService.Close();
    }

    private async Task OpenCreateDagSkabelonDialog()
    {
        var parameters = new Dictionary<string, object>
        {
            { "OnAdd", EventCallback.Factory.Create<DagSkabelon>(this, OnDagSkabelonAdd) }
        };

        // Åbner CreateDagSkabelonComponent i en dialog
        var result = await DialogService.OpenAsync<CreateDagSkabelonComponent>("Opret Ny DagSkabelon", parameters);
    }
}
